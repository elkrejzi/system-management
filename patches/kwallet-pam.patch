From b6a9967e3b746121c500246b62c69b21aad75e17 Mon Sep 17 00:00:00 2001
From: Armin K <krejzi@email.com>
Date: Fri, 22 Jan 2016 15:19:29 +0100
Subject: [PATCH] Added a script that connects pam_kwallet to kwalletd.

---
 CMakeLists.txt                 | 13 +++++++++++--
 pam_kwallet_init               | 10 ++++++++++
 pam_kwallet_init.desktop.cmake |  9 +++++++++
 3 files changed, 30 insertions(+), 2 deletions(-)
 create mode 100755 pam_kwallet_init
 create mode 100644 pam_kwallet_init.desktop.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 8bd526e..a57cdbc 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,10 +1,13 @@
 project(pam_kwallet)
-cmake_minimum_required(VERSION 2.8.8)
+cmake_minimum_required (VERSION 2.8.12 FATAL_ERROR)
 
 set(PROJECT_VERSION "5.5.90")
 set(PROJECT_VERSION_MAJOR 5)
 
-set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules" )
+find_package (ECM 1.2.0 REQUIRED NO_MODULE)
+set (CMAKE_MODULE_PATH ${ECM_MODULE_PATH} "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules" )
+
+include(KDEInstallDirs)
 
 find_package(PAM REQUIRED)
 find_package(LibGcrypt 1.5.0 REQUIRED)
@@ -43,3 +46,9 @@ target_link_libraries (${library_name}
 )
 
 install(TARGETS ${library_name} DESTINATION ${CMAKE_INSTALL_LIBDIR}/security)
+
+configure_file(pam_kwallet_init.desktop.cmake ${CMAKE_BINARY_DIR}/pam_kwallet_init.desktop)
+
+install(PROGRAMS pam_kwallet_init DESTINATION ${LIBEXEC_INSTALL_DIR})
+
+install(FILES ${CMAKE_BINARY_DIR}/pam_kwallet_init.desktop DESTINATION ${AUTOSTART_INSTALL_DIR})
diff --git a/pam_kwallet_init b/pam_kwallet_init
new file mode 100755
index 0000000..e1d7f1a
--- /dev/null
+++ b/pam_kwallet_init
@@ -0,0 +1,10 @@
+#!/bin/sh
+
+if test -n "$PAM_KWALLET_LOGIN" ; then
+    env | socat STDIN UNIX-CONNECT:$PAM_KWALLET_LOGIN
+fi
+
+if test -n "$PAM_KWALLET5_LOGIN" ; then
+    env | socat STDIN UNIX-CONNECT:$PAM_KWALLET5_LOGIN
+fi
+
diff --git a/pam_kwallet_init.desktop.cmake b/pam_kwallet_init.desktop.cmake
new file mode 100644
index 0000000..ff5b5f7
--- /dev/null
+++ b/pam_kwallet_init.desktop.cmake
@@ -0,0 +1,9 @@
+[Desktop Entry]
+Name=KWallet PAM Socket Connection
+Comment=Connect to KWallet PAM socket
+Exec=${CMAKE_INSTALL_FULL_LIBEXECDIR}/pam_kwallet_init
+Type=Application
+NoDisplay=true
+OnlyShowIn=KDE;GNOME;Unity;XFCE
+X-KDE-StartupNotify=false
+X-KDE-autostart-phase=0
-- 
2.7.0

