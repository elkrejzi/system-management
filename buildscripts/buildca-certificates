#!/bin/bash -e

export VER=20141019
export DEST=/binary/ca-certificates-${VER}

pushd ca-certificates-${VER}

make

install -d -m755 ${DEST}/etc/ca-certificates/update.d \
                 ${DEST}/etc/ssl/certs \
                 ${DEST}/usr/sbin \
                 ${DEST}/usr/share/ca-certificates

make install DESTDIR=${DEST}

install -D -m644 sbin/update-ca-certificates.8 ${DEST}/usr/share/man/man8/update-ca-certificates.8

(
echo "# Automatically generated by ca-certificates-${VER}"
echo "# see update-ca-certificates man page"
echo "# "
cd ${DEST}/usr/share/ca-certificates
find . -name '*.crt' | sort | cut -b3-
) > ${DEST}/etc/ca-certificates.conf

popd

rm -rf ca-certificates-${VER}

cat > ${DEST}/INSTALL << "EOF"
#!/bin/bash

for dir in etc usr ; do cp -rf --remove-destination $dir / ; done

/usr/sbin/update-ca-certificates

[ -x /usr/bin/mandb ] && echo "Processing triggers for man-db" && /usr/bin/mandb -q
EOF

chmod 755 ${DEST}/INSTALL
